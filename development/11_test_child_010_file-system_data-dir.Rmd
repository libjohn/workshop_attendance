
## Load Packages

```{r packages}
library(tidyverse)
library(fs)
```

## Import Data

### Registration Data

Instructor will download the registered and waitlist files from libcal (SpringShare).  Below, the instructor will choose the location of these files on the filesystem.  

```{r import-registration-data}
files_table <- as_tibble(path_rel(choose.files()))

full_file_names <- files_table %>% 
  rename(relpath = value) %>% 
  filter(str_detect(path_ext(relpath), 
                    fixed("csv", ignore_case = TRUE))) %>% 
  mutate(reg_data = map(relpath, read_csv, skip = 9)) %>% 
  unnest()
  

full_file_names  
```

### Workshop Metadata

```{r roster-header}
attendees_header <- read_csv(head(files_table$value, 1), 
                             skip=1, n_max = 7, 
                             col_names = FALSE) %>% 
  spread(X1, X2)

attendees_header



```



``` r
  mutate(data_dir = path_dir(relpath)) %>% 
  mutate(data_filename = path_file(relpath)) %>% 
  mutate(metadata_filename = str_replace(relpath, 
                                   "wait_list", 
                                   "waitlist")) %>% 
  mutate(metadata_filename = str_extract(metadata_filename,
                           "lc_\\w+_\\d+")) %>% 
  separate(metadata_filename, 
           into = c("prefix", "type", "workshop_id")) %>% 
  separate(workshop_id, 
           into = c("workshop_id", "download_date", "pid"), 
           sep = c(7,15))

glimpse(full_file_names)

```





```{r}
files_table <- as_tibble(path_rel(choose.files()))
full_file_names <- files_table %>% 
  rename(relpath = value) %>% 
  mutate(data_dir = path_dir(relpath)) %>% 
  mutate(data_file = path_file(relpath)) %>% 
  mutate(metadata_filename = str_replace(relpath, 
                                   "wait_list", 
                                   "waitlist")) %>% 
  mutate(metadata_filename = str_extract(metadata_filename,
                           "lc_\\w+_\\d+")) %>% 
  separate(metadata_filename, 
           into = c("prefix", "type", "workshop_id")) %>% 
  separate(workshop_id, 
           into = c("workshop_id", "download_date", "pid"), 
           sep = c(7,15))
```







## WTF
https://serialmentor.com/blog/2016/6/13/reading-and-combining-many-tidy-data-files-in-R








``` r
#library(here)
#files_chosen <- choose.files()
#file_info(files_chosen)
#path_split(files_chosen)
#path_rel(files_chosen)

#last(str_split(path_rel(files_chosen), "/"))
#files_chosen <- choose.files()


  
####file_parts <- str_extract(full_file_names, "lc_\\w+_.*\\.csv")
#file_names
#file_names <- str_replace(file_names, "wait_list", "waitlist")
#files <- as_tibble(str_split(full_file_names$metadata_filename, 
#                             "_", simplify = T))
#files

#fs::path_rel(full_file_names)

###  path_file(full_file_names)
###  path_dir(full_file_names)

#file_names
#file_info(files_chosen)$path
#path_sanitize(files_chosen)
#path_tidy(files_chosen)
#file_show()
#here::here()

#dir_ls(choose.dir(), type="file", glob = "*.csv")
#dir_ls(choose.dir(), type="file", regexp = "lc_attend")
```

``` r
files <- files %>% 
  rename(prefix = V1, type = V2, id = V3) %>% 
  #mutate(id = if_else(id == "list", id2, id)) %>% 
  mutate(type = if_else(type == "waitlist", 
                        "wait_list", type)) %>% 
  mutate(download_date = str_sub(id, 8, -5)) %>% 
  mutate(course_id = str_sub(id, 1,7)) %>% 
  mutate(file_name = paste0(prefix, "_", 
                            type, "_", course_id, 
                            download_date, ".csv")) %>% 
  select(-id) %>% 
  arrange(type)

files
```


###  Load Data Files
``` r 
files <- as_tibble(str_split(list.files(data_dir), 
                             "_", simplify = T, 4))

files
```

### As Data Frame

Organize the filesystem data into a data frame

``` r 

files <- files %>% 
  rename(prefix = V1, type = V2, id = V3, id2 = V4) %>% 
  mutate(id = if_else(id == "list", id2, id)) %>% 
  mutate(type = if_else(type == "wait", 
                        "wait_list", type)) %>% 
  mutate(download_date = str_sub(id, 8, -5)) %>% 
  mutate(course_id = str_sub(id, 1,7)) %>% 
  mutate(file_name = paste0(data_dir, 
                            "/", prefix, "_", 
                            type, "_", course_id, 
                            download_date, ".csv")) %>% 
  select(-id2, -id) %>% 
  arrange(type)

files
```


###  Attendees as a Data Frame

Generate metadata about the Attendees (confirmed) filename

``` r
attendees_file_path <- files %>% 
  filter(type == "attendees") %>% 
  select(file_name, course_id)

attendees_file_path
```

