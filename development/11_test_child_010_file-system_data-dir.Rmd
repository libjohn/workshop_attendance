## Child Document -- File System Activity

#### Note to John

Eventually upgrade this to use
- `library(here)`
- `library(fs)`

###  USER INIPUT:  Enter your data directory

#### Note to John

I should make this either parameterized or an input to the kniter command line.  But until then...

### Identify Data Directory

User should place all attendance, waitlist, and cancelled files (if usd) in the 'data' subdirectory of the project directory.

```{r child_datadir}
#data_dir <- "data"   # identify the data directory
library(tidyverse)
library(fs)
```


```{r}
files_table <- as_tibble(path_rel(choose.files()))
full_file_names <- files_table %>% 
  rename(relpath = value) %>% 
  mutate(data_dir = path_dir(relpath)) %>% 
  mutate(data_filename = path_file(relpath)) %>% 
  mutate(metadata_filename = str_replace(relpath, 
                                   "wait_list", 
                                   "waitlist")) %>% 
  mutate(metadata_filename = str_extract(metadata_filename,
                           "lc_\\w+_\\d+")) %>% 
  separate(metadata_filename, 
           into = c("prefix", "type", "workshop_id")) %>% 
  separate(workshop_id, 
           into = c("workshop_id", "download_date", "pid"), 
           sep = c(7,15))

glimpse(full_file_names)

```

```{r}
full_file_names %>% 
  mutate(reg_data = map(relpath, read_csv, skip = 9)) %>% 
  unnest()

#map(full_file_names$relpath, read_csv, skip = 9) %>% 
#  bind_rows()

```



```{r}
files_table <- as_tibble(path_rel(choose.files()))
full_file_names <- files_table %>% 
  rename(relpath = value) %>% 
  mutate(data_dir = path_dir(relpath)) %>% 
  mutate(data_file = path_file(relpath)) %>% 
  mutate(metadata_filename = str_replace(relpath, 
                                   "wait_list", 
                                   "waitlist")) %>% 
  mutate(metadata_filename = str_extract(metadata_filename,
                           "lc_\\w+_\\d+")) %>% 
  separate(metadata_filename, 
           into = c("prefix", "type", "workshop_id")) %>% 
  separate(workshop_id, 
           into = c("workshop_id", "download_date", "pid"), 
           sep = c(7,15))
```



```{r}
read_skip_9 = function(file) {
  skip9 <- read_csv(file, skip = 9)
}
```


```{r}
read_skip_9()
```



## WTF
https://serialmentor.com/blog/2016/6/13/reading-and-combining-many-tidy-data-files-in-R

```{r}

files <- dir("../data/intro2r/")
data_path <- "data/intro2r/"
files <- dir(data_path, pattern = "*.csv")

file.path(dir("../data/intro2r"))


files %>% 
  map_dfr(~ read_csv(file.path(data_path, .), skip = 9))


data_frame(filename = files) %>% 
  mutate(file_contents = map_dfr(~, read_csv(file.path(data_path, .), skip = 9)))

data_frame(filename = files) %>% 
  mutate(file_contents = map_dfr(), read_csv, skip = 9)


full_file_names %>% 
  mutate(contents = map(relpath, 
                        ~ read_csv(relpath)))

#files <- path_rel(choose.files())

data_frame(filename = files) %>% 
  mutate(files_contents = map(filename,
                              ~ read_csv(file.path(data_path, .))))

```



```{r}
files_vector <- path_rel(choose.files())

df()
```



``` r
#library(here)
#files_chosen <- choose.files()
#file_info(files_chosen)
#path_split(files_chosen)
#path_rel(files_chosen)

#last(str_split(path_rel(files_chosen), "/"))
#files_chosen <- choose.files()


  
####file_parts <- str_extract(full_file_names, "lc_\\w+_.*\\.csv")
#file_names
#file_names <- str_replace(file_names, "wait_list", "waitlist")
#files <- as_tibble(str_split(full_file_names$metadata_filename, 
#                             "_", simplify = T))
#files

#fs::path_rel(full_file_names)

###  path_file(full_file_names)
###  path_dir(full_file_names)

#file_names
#file_info(files_chosen)$path
#path_sanitize(files_chosen)
#path_tidy(files_chosen)
#file_show()
#here::here()

#dir_ls(choose.dir(), type="file", glob = "*.csv")
#dir_ls(choose.dir(), type="file", regexp = "lc_attend")
```

``` r
files <- files %>% 
  rename(prefix = V1, type = V2, id = V3) %>% 
  #mutate(id = if_else(id == "list", id2, id)) %>% 
  mutate(type = if_else(type == "waitlist", 
                        "wait_list", type)) %>% 
  mutate(download_date = str_sub(id, 8, -5)) %>% 
  mutate(course_id = str_sub(id, 1,7)) %>% 
  mutate(file_name = paste0(prefix, "_", 
                            type, "_", course_id, 
                            download_date, ".csv")) %>% 
  select(-id) %>% 
  arrange(type)

files
```


###  Load Data Files
``` r 
files <- as_tibble(str_split(list.files(data_dir), 
                             "_", simplify = T, 4))

files
```

### As Data Frame

Organize the filesystem data into a data frame

``` r 

files <- files %>% 
  rename(prefix = V1, type = V2, id = V3, id2 = V4) %>% 
  mutate(id = if_else(id == "list", id2, id)) %>% 
  mutate(type = if_else(type == "wait", 
                        "wait_list", type)) %>% 
  mutate(download_date = str_sub(id, 8, -5)) %>% 
  mutate(course_id = str_sub(id, 1,7)) %>% 
  mutate(file_name = paste0(data_dir, 
                            "/", prefix, "_", 
                            type, "_", course_id, 
                            download_date, ".csv")) %>% 
  select(-id2, -id) %>% 
  arrange(type)

files
```


###  Attendees as a Data Frame

Generate metadata about the Attendees (confirmed) filename

``` r
attendees_file_path <- files %>% 
  filter(type == "attendees") %>% 
  select(file_name, course_id)

attendees_file_path
```

