---
title: "coercing attendance and waitlist"
params:
  dat_dir: "data"
---

To Run:

1. rm(list = ls(all = TRUE))
2. rmarkdown::render("process_files_to_df.Rmd", params = list(dat_dir = "data"))

```{r, message=FALSE, warning=FALSE}
## rm(list = ls(all = TRUE)) 

library(tidyverse)
library(readr)
library(lubridate)
library(stringr)

# params$dat_dir <- "data/openrefine0123"  # dat_dir <- "data/openrefine0117"
# WaitList <- NULL
# Attendees <- NULL
# forGoogleDrive_Cancelled <- NULL

## getwd()

data_dir <- params$dat_dir
```


## Read files

- take first file, split by rows
- workshop ID is in substring 14-20 of the filename
- attendees dataframe starts at line 10
- other workshop metadata is in lines 2-7
- file type is in line 1 (attendance, waitlist, cancellation)

### Step 1

Assumptions

- getwd is project folder.  e.g. "C:/Users/john/Documents/R Projects/workshop_analytics"

- "data" : file-system directory exists within getwd()
- "output" : file-system directory for modified output

```{r getFiles}
files <- as_tibble(str_split(list.files(data_dir), "_", simplify = T, 4))

files <- files %>% 
  rename(prefix = V1, type = V2, id = V3, id2 = V4) %>% 
  mutate(id = if_else(id == "list", id2, id)) %>% 
  mutate(type = if_else(type == "wait", "wait_list", type)) %>% 
  mutate(download_date = str_sub(id, 8, -5)) %>% 
  mutate(course_id = str_sub(id, 1,7)) %>% 
  mutate(file_name = paste0(params$dat_dir, "/", prefix, "_", type, "_", course_id, download_date, ".csv")) %>% 
  select(-id2, -id) %>% 
  arrange(type)
```

#### Attendees file
```{r produceAttendeesList}
attendees_file_path <- files %>% 
  filter(type == "attendees") %>% 
  select(file_name, course_id)

Attendees <- read_csv(attendees_file_path$file_name, skip=9) %>% 
  mutate(list_type = "attendee") %>% 
  mutate(WorkshopID = attendees_file_path$course_id)

attendees_header <- read_csv(attendees_file_path$file_name, skip=1, n_max = 7, col_names = FALSE)

```

#### Wait List
```{r produceWait_List}

if("wait_list" %in% files$type){
  wl_file_path <- files %>% 
    filter(type == "wait_list") %>% 
    select(file_name, course_id)
  
  WaitList <- read_csv(wl_file_path$file_name, skip=9)%>% 
    mutate(list_type = "wait list") %>% 
    mutate(WorkshopID = wl_file_path$course_id)
} 

```

#### Cancelled List
```{r produceCancelled}
if("cancelled" %in% files$type){
  cancelled_file_path <- files %>% 
    filter(type == "cancelled")
  
  forGoogleDrive_Cancelled <- read_csv(cancelled_file_path$file_name, skip = 8)
} 
```

