---
title: "Generate Attendance List -- Version: 2018-Spring"
---

This script takes the registration CSV file from the LibCal registration tool and generates a more useful attendance roster that can be printed in advance of the class.

```{r}
library(tidyverse)
library(readr)
library(lubridate)
library(stringr)
library(googlesheets)
```


##  USER INIPUT:  Enter your data directory

```{r}
data_dir <- "data"   # identify the data directory
```


##  Load Data Files

```{r}
files <- as_tibble(str_split(list.files(data_dir), 
                             "_", simplify = T, 4))
files
```


```{r}
files <- files %>% 
  rename(prefix = V1, type = V2, id = V3, id2 = V4) %>% 
  mutate(id = if_else(id == "list", id2, id)) %>% 
  mutate(type = if_else(type == "wait", 
                        "wait_list", type)) %>% 
  mutate(download_date = str_sub(id, 8, -5)) %>% 
  mutate(course_id = str_sub(id, 1,7)) %>% 
  mutate(file_name = paste0(data_dir, 
                            "/", prefix, "_", 
                            type, "_", course_id, 
                            download_date, ".csv")) %>% 
  select(-id2, -id) %>% 
  arrange(type)

files
```



##  Attendees as a Data Frame

Generate metadata about the Attendees (confirmed) filename
```{r}
attendees_file_path <- files %>% 
  filter(type == "attendees") %>% 
  select(file_name, course_id)

attendees_file_path
```

Coerce the Attendees (confirmed) data into a data frame

```{r}
Attendees <- read_csv(attendees_file_path$file_name, 
                      skip=9) %>% 
  mutate(list_type = "attendee") %>% 
  mutate(WorkshopID = attendees_file_path$course_id)

Attendees
```

### Registration Fields

Taken from row 8 of the libcal registration CSV

```{r}
registration_fields_libcal_form <- read_csv(attendees_file_path$file_name, 
                                                 skip=8) %>% 
  head(1) %>% 
  as_vector() %>% 
  unname()

registration_fields_libcal_form
```

## Metadata about the Workshop.  

- Event	
- Date	
- Time	
- Presenter	
- Location	
- Campus	
- Seats

```{r}
attendees_header <- read_csv(attendees_file_path$file_name, 
                             skip=1, n_max = 7, 
                             col_names = FALSE)


attendees_header
```

### Coerce Date

```{}
eventMetaData_attendees <- attendees_header %>% 
  spread(X1, X2) 

eventDate <- mdy(
  str_split(
    eventMetaData_attendees$Date, ", ", 2
  )[[1]][2]
)

eventMetaData_attendees

eventDate
```

```{r}
eventDate <- attendees_header %>% 
  spread(X1, X2) %>%
  mutate(Date2 = as.character(mdy(str_replace(Date, "\\w+,\\s", "")))) %>% 
  select(Date2) %>% 
  head(1) %>% 
  as_vector() %>% 
  unname()
  

eventDate
```


##  Wailt List as Data Frame

Not all workshops have waitlists.  Therefore, This step is wrapped in an IF function to fail gracefully.

```{r}

if("wait_list" %in% files$type){
  wl_file_path <- files %>% 
    filter(type == "wait_list") %>% 
    select(file_name, course_id)
  
  WaitList <- read_csv(wl_file_path$file_name, 
                       skip=9)%>% 
    mutate(list_type = "wait list") %>% 
    mutate(WorkshopID = wl_file_path$course_id)
}  

WaitList

```


##  Cancellations as a Data Frame

```{r}
if("cancelled" %in% files$type){
  cancelled_file_path <- files %>% 
    filter(type == "cancelled")
  
  forGoogleDrive_Cancelled <- read_csv(cancelled_file_path$file_name, skip = 8)
} 
```



### Combine Attendee & Waitlist 

```{r}
registration_fields_libcal_form
```

#### Attendees

```{r}
forGoogleDrive_attendees <- Attendees %>% 
  mutate("Workshop Name" = eventMetaData_attendees$Event) %>% 
  mutate("Workshop Date" = as.character(eventDate)) %>% 
  mutate("Attended" = "") %>% 
  mutate("Walk-in" = "") %>% 
  mutate("Waitlist" = "") %>% 
  select(Attended, "Walk-in", Waitlist, list_type,
         "Workshop Date", "Workshop Name", WorkshopID, 1:4, 6:20)
```

#### Waitlist

```{r}
if("wait_list" %in% files$type){
  forGoogleDrive_WaitList <- WaitList %>% 
    mutate("Workshop Name" = eventMetaData_attendees$Event) %>% 
    mutate("Workshop Date" = as.character(eventDate)) %>% 
    mutate("Attended" = "") %>% 
    mutate("Walk-in" = "") %>% 
    mutate("Waitlist" = "") %>% 
    select(Attended, "Walk-in", Waitlist, list_type,
         "Workshop Date", "Workshop Name", WorkshopID, 1:4, 6:20)
}

```

#### Combine Attendees and Wait List

```{r}
if("wait_list" %in% files$type){
  forGoogleDrive_attendees <- bind_rows(
    forGoogleDrive_attendees,
    forGoogleDrive_WaitList
  ) %>% 
    arrange(`Last Name`)
} else {
  forGoogleDrive_attendees <- forGoogleDrive_attendees %>% 
    arrange(`Last Name`)
}
```

## Write Roster as a .txt file

```{r}

# Create attendance CSV file; append header
attendees_header %>% 
  write_excel_csv("outfile/attendance-roster.csv", col_names = FALSE)

# append blank line to attendance CSV file
blank <-  as_tibble(" ")
blank %>% 
  write_excel_csv("outfile/attendance-roster.csv", append = TRUE)

# Create an Example Entry
Example <- tibble(
  `Last Name` = "Chigurh", 
  `First Name` = "Anton", 
  Email = "cipher@cloud.net", 
  `Academic Status (or other)` = "Perpetual", 
  `Discipline or Affiliation` = "Sanitation", 
  list_type = "Example")

# Create a Roster data frame by adding the Example Entry data frame and the Attendees data frame
Roster <- bind_rows(Attendees, 
                    Example,
                    if("wait_list" %in% files$type){WaitList}
)

# append the Roster data frame to the attendance CSV file
Roster %>% 
  select(`Last Name`, `First Name`, `Email`, 
         Status = `Academic Status (or other)`, 
         Discipline = `Discipline or Affiliation`, 
         Registration = list_type) %>% 
  arrange(`Last Name`) %>% 
  mutate(Attendance = "") %>% 
  mutate(Attendance = if_else(Status == "Perpetual", 
                              "X", Attendance)) %>% 
  write_excel_csv("outfile/attendance-roster.csv", 
                  append = TRUE, col_names = TRUE)
```
